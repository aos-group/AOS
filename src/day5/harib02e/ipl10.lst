     1 00000000                                 ; hello-os
     2 00000000                                 ; TAB=4
     3 00000000                                 
     4  = 0000000A                              	CYLS	equ		10		; 加载柱面的数量
     5 00000000                                 
     6                                          	org	0x7c00				; 指明程序的装载地址
     7 00007C00                                 
     8 00007C00                                 ; 以下这段是标准 FAT12 格式软盘专用的代码
     9 00007C00                                 	
    10 00007C00 EB 4E                           	jmp	entry
    11 00007C02 90                              	db	0x90
    12 00007C03 48 41 52 49 42 4F 54 45         	db	"HARIBOTE"			; 启动区的名称，8字节
    13 00007C0B 0200                            	dw	512					; 扇区大小/字节
    14 00007C0D 01                              	db	1					; 簇(分配的最小单位)的大小
    15 00007C0E 0001                            	dw	1					; FAT 的起始位置 (一般从第一个扇区开始)
    16 00007C10                                 			; 第一行结束
    17 00007C10 02                              	db	2					; FAT 的个数 (固定)
    18 00007C11 00E0                            	dw	224					; 根目录的大小/项 (默认)
    19 00007C13 0B40                            	dw	2880				; 磁盘的大小/扇区 (固定)
    20 00007C15 F0                              	db	0xf0 				; 磁盘的种类 (固定)
    21 00007C16 0009                            	dw	9					; FAT 的长度/扇区 (固定)
    22 00007C18 0012                            	dw	18					; 1 个磁道的扇区数 (固定)
    23 00007C1A 0002                            	dw	2					; 磁头数 (固定)
    24 00007C1C 00000000                        	dd	0					; 不使用分区
    25 00007C20                                 			; 第二行结束
    26 00007C20 00000B40                        	dd	2880				; 重写一次磁盘大小
    27 00007C24 00 00 29                        	db	0x00, 0x00, 0x29	; 固定
    28 00007C27 FFFFFFFF                        	dd	0xffffffff			; 卷标号码
    29 00007C2B 48 41 52 49 42 4F 54 45 4F 53   	db	"HARIBOTEOS "		; 磁盘的名称 (11 字节)
       00007C35 20 
    30 00007C36 46 41 54 31 32 20 20 20         	db	"FAT12   "			; 磁盘格式名称 (8 字节)
    31 00007C3E 00 00 00 00 00 00 00 00 00 00   	resb	18
       00007C48 00 00 00 00 00 00 00 00 
    32 00007C50                                 			; 第五行结束
    33 00007C50                                 
    34 00007C50                                 ; 程序主体
    35 00007C50                                 
    36 00007C50                                 entry:
    37 00007C50 B8 0000                         	mov	ax, 0
    38 00007C53 8E D0                           	mov ss, ax
    39 00007C55 BC 7C00                         	mov sp, 0x7c00
    40 00007C58 8E D8                           	mov ds, ax
    41 00007C5A                                 	
    42 00007C5A                                 ; 读磁盘
    43 00007C5A                                 ; 返回值：flags.cf == 0: 没有错误, ah == 0
    44 00007C5A                                 ;		 flags.cf == 1: 有错误, ah == 错误号
    45 00007C5A B8 0820                         	mov ax, 0x0820
    46 00007C5D 8E C0                           	mov es, ax
    47 00007C5F B5 00                           	mov ch, 0				; 柱面 一级编号
    48 00007C61 B6 00                           	mov dh, 0				; 磁头 二级编号
    49 00007C63 B1 02                           	mov cl, 2				; 扇区 三级编号
    50 00007C65                                 readloop:
    51 00007C65 BE 0000                         	mov si, 0				; 记录失败次数的寄存器
    52 00007C68                                 retry:
    53 00007C68 B4 02                           	mov ah, 0x2 			; 读盘
    54 00007C6A B0 01                           	mov al, 1				; 连续的扇区数
    55 00007C6C BB 0000                         	mov bx, 0				; es:bx = 缓冲区地址
    56 00007C6F B2 00                           	mov dl, 0x00 			; A 驱动器
    57 00007C71 CD 13                           	int 0x13 				; 调用磁盘 BIOS
    58 00007C73 73 0E                           	jnc next
    59 00007C75 46                              	inc si
    60 00007C76 83 FE 05                        	cmp si, 5
    61 00007C79 73 32                           	jae error
    62 00007C7B B4 00                           	mov ah, 0x00
    63 00007C7D B2 00                           	mov dl, 0x00
    64 00007C7F CD 13                           	int 0x13				; 重置驱动器
    65 00007C81 EB E5                           	jmp retry
    66 00007C83                                 next:
    67 00007C83 8C C0                           	mov ax, es
    68 00007C85 05 0020                         	add ax, 0x0020
    69 00007C88 8E C0                           	mov es, ax
    70 00007C8A FE C1                           	inc cl
    71 00007C8C 80 F9 12                        	cmp cl, 18
    72 00007C8F 76 D4                           	jbe readloop
    73 00007C91 B1 01                           	mov cl, 1
    74 00007C93 FE C6                           	inc dh
    75 00007C95 80 FE 02                        	cmp dh, 2
    76 00007C98 72 CB                           	jb 	readloop
    77 00007C9A B6 00                           	mov dh, 0
    78 00007C9C FE C5                           	inc ch
    79 00007C9E 80 FD 0A                        	cmp ch, CYLS
    80 00007CA1 72 C2                           	jb 	readloop
    81 00007CA3                                 
    82 00007CA3 88 2E 0FF0                      	mov [0x0ff0], ch		; ipl 读取结束时的扇区号
    83 00007CA7 E9 4556                         	jmp 0xc200
    84 00007CAA                                 
    85 00007CAA                                 fin:
    86 00007CAA F4                              	hlt
    87 00007CAB EB FD                           	jmp fin
    88 00007CAD                                 
    89 00007CAD                                 error:
    90 00007CAD BE 7CC0                         	mov si, msg
    91 00007CB0                                 putloop:
    92 00007CB0 8A 04                           	mov al, [si]			; 待打印的字符
    93 00007CB2 46                              	inc si
    94 00007CB3 3C 00                           	cmp al, 0
    95 00007CB5 74 F3                           	je 	fin
    96 00007CB7 B4 0E                           	mov ah, 0x0e			; 显示一个字符
    97 00007CB9 BB 0002                         	mov bx, 2				; 指定字符颜色
    98 00007CBC CD 10                           	int 0x10				; 调用显卡 BIOS
    99 00007CBE EB F0                           	jmp putloop
   100 00007CC0                                 
   101 00007CC0                                 ; 信息显示部分
   102 00007CC0                                 msg:
   103 00007CC0 0A 0A                           	db 	0x0a, 0x0a	; 换行
   104 00007CC2 6C 6F 61 64 20 65 72 72 6F 72   	db	"load error"
   105 00007CCC 0A                              	db	0x0a
   106 00007CCD 00                              	db	0
   107 00007CCE 00 00 00 00 00 00 00 00 00 00   	resb	0x7dfe - $		; 0x7dfe = 0x7c00 + 0x1fe
       00007CD8 00 00 00 00 00 00 00 00 00 00 
       00007CE2 00 00 00 00 00 00 00 00 00 00 
       00007CEC 00 00 00 00 00 00 00 00 00 00 
       00007CF6 00 00 00 00 00 00 00 00 00 00 
       00007D00 00 00 00 00 00 00 00 00 00 00 
       00007D0A 00 00 00 00 00 00 00 00 00 00 
       00007D14 00 00 00 00 00 00 00 00 00 00 
       00007D1E 00 00 00 00 00 00 00 00 00 00 
       00007D28 00 00 00 00 00 00 00 00 00 00 
       00007D32 00 00 00 00 00 00 00 00 00 00 
       00007D3C 00 00 00 00 00 00 00 00 00 00 
       00007D46 00 00 00 00 00 00 00 00 00 00 
       00007D50 00 00 00 00 00 00 00 00 00 00 
       00007D5A 00 00 00 00 00 00 00 00 00 00 
       00007D64 00 00 00 00 00 00 00 00 00 00 
       00007D6E 00 00 00 00 00 00 00 00 00 00 
       00007D78 00 00 00 00 00 00 00 00 00 00 
       00007D82 00 00 00 00 00 00 00 00 00 00 
       00007D8C 00 00 00 00 00 00 00 00 00 00 
       00007D96 00 00 00 00 00 00 00 00 00 00 
       00007DA0 00 00 00 00 00 00 00 00 00 00 
       00007DAA 00 00 00 00 00 00 00 00 00 00 
       00007DB4 00 00 00 00 00 00 00 00 00 00 
       00007DBE 00 00 00 00 00 00 00 00 00 00 
       00007DC8 00 00 00 00 00 00 00 00 00 00 
       00007DD2 00 00 00 00 00 00 00 00 00 00 
       00007DDC 00 00 00 00 00 00 00 00 00 00 
       00007DE6 00 00 00 00 00 00 00 00 00 00 
       00007DF0 00 00 00 00 00 00 00 00 00 00 
       00007DFA 00 00 00 00 
   108 00007DFE 55 AA                           	db	0x55, 0xaa